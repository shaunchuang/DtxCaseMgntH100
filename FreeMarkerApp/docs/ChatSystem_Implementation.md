# èŠå¤©ç³»çµ±é–‹ç™¼å®Œæˆå ±å‘Š

## æ¦‚è¿°
å·²å®Œæˆä¸€å¥—å®Œæ•´çš„èŠå¤©ç³»çµ±ï¼ŒåŒ…å«å¾Œç«¯APIã€å‰ç«¯ä»‹é¢ï¼Œæ”¯æ´ç¾¤çµ„/ç§èŠåŠŸèƒ½ï¼Œä¸¦å¯¦ä½œäº†æ­·å²è¨Šæ¯åˆ†é è¼‰å…¥åŠŸèƒ½ã€‚

## æœ€æ–°æ›´æ–° (2024-12-26)

### æ–°å¢åŠŸèƒ½
1. **æ­·å²è¨Šæ¯åˆ†é è¼‰å…¥**: 
   - å¯¦ä½œ `ChatAPI.getMessagesBefore()` æ–¹æ³•
   - åœ¨ `ChatRESTfulAPI` ä¸­æ”¯æ´ `beforeMessageId` åƒæ•¸
   - å‰ç«¯æ”¯æ´å‘ä¸Šæ»¾å‹•è‡ªå‹•è¼‰å…¥æ›´å¤šæ­·å²è¨Šæ¯

2. **å‰ç«¯ä»‹é¢å„ªåŒ–**:
   - æ·»åŠ æ‰‹å‹•åˆ·æ–°æŒ‰éˆ•
   - åœ¨è¨Šæ¯å€åŸŸé ‚éƒ¨æ·»åŠ æç¤ºæ–‡å­—
   - æ”¹é€²æ»¾å‹•è¼‰å…¥é‚è¼¯ï¼Œä¿æŒä½¿ç”¨è€…ç€è¦½ä½ç½®

3. **APIå®Œå–„**:
   - ä¿®æ­£ `ChatMessageDAO.findMessagesBefore()` æ–¹æ³•
   - çµ±ä¸€ä½¿ç”¨ `save()` æ–¹æ³•é€²è¡Œè³‡æ–™å„²å­˜
   - å®Œå–„éŒ¯èª¤è™•ç†æ©Ÿåˆ¶

## å·²å®ŒæˆåŠŸèƒ½

### 1. å¾Œç«¯æ¨¡çµ„

#### Modelï¼ˆè³‡æ–™æ¨¡å‹ï¼‰
- **ChatRoom**: èŠå¤©å®¤å¯¦é«”
- **ChatRoomUser**: èŠå¤©å®¤æˆå“¡é—œä¿‚
- **ChatMessage**: èŠå¤©è¨Šæ¯
- **ChatMessageRead**: è¨Šæ¯å·²è®€ç‹€æ…‹

#### DAOï¼ˆè³‡æ–™å­˜å–å±¤ï¼‰
- **ChatRoomDAO**: èŠå¤©å®¤è³‡æ–™å­˜å–
- **ChatRoomUserDAO**: æˆå“¡é—œä¿‚è³‡æ–™å­˜å–
- **ChatMessageDAO**: è¨Šæ¯è³‡æ–™å­˜å–
- **ChatMessageReadDAO**: å·²è®€ç‹€æ…‹è³‡æ–™å­˜å–

#### APIï¼ˆæ¥­å‹™é‚è¼¯å±¤ï¼‰
- **ChatAPI**: èŠå¤©ç³»çµ±æ ¸å¿ƒé‚è¼¯
- **ChatRoomAPI**: èŠå¤©å®¤ç®¡ç†
- **ChatRoomUserAPI**: æˆå“¡ç®¡ç†
- **ChatMessageAPI**: è¨Šæ¯ç®¡ç†
- **ChatMessageReadAPI**: å·²è®€ç‹€æ…‹ç®¡ç†

#### RESTful APIï¼ˆHTTPä»‹é¢ï¼‰
- **ChatRESTfulAPI**: æä¾›HTTP APIç«¯é»
  - `/Chat/api/createChatRoom` - å»ºç«‹èŠå¤©å®¤
  - `/Chat/api/joinChatRoom` - åŠ å…¥èŠå¤©å®¤
  - `/Chat/api/sendMessage` - ç™¼é€è¨Šæ¯
  - `/Chat/api/loadChatRooms` - è¼‰å…¥èŠå¤©å®¤åˆ—è¡¨
  - `/Chat/api/loadMessages` - è¼‰å…¥èŠå¤©è¨Šæ¯
  - `/Chat/api/markAsRead` - æ¨™è¨˜å·²è®€
  - `/Chat/api/createPrivateChat` - å»ºç«‹ç§èŠ
  - `/Chat/api/getUnreadCount` - å–å¾—æœªè®€æ•¸é‡
  - `/Chat/api/getRoomMembers` - å–å¾—æˆå“¡åˆ—è¡¨
  - `/Chat/api/leaveChatRoom` - é›¢é–‹èŠå¤©å®¤

### 2. å‰ç«¯ä»‹é¢

#### èŠå¤©å®¤åˆ—è¡¨é é¢ï¼ˆchatlist.ftlï¼‰
- é¡¯ç¤ºä½¿ç”¨è€…åƒèˆ‡çš„æ‰€æœ‰èŠå¤©å®¤
- æ”¯æ´å»ºç«‹æ–°èŠå¤©å®¤
- å³æ™‚æ›´æ–°èŠå¤©å®¤ç‹€æ…‹
- éŸ¿æ‡‰å¼è¨­è¨ˆï¼Œæ”¯æ´å„ç¨®è£ç½®

#### èŠå¤©å®¤é é¢ï¼ˆchatroom.ftlï¼‰
- å³æ™‚èŠå¤©ä»‹é¢
- è¨Šæ¯ç™¼é€èˆ‡æ¥æ”¶
- æˆå“¡åˆ—è¡¨æŸ¥çœ‹
- è¨Šæ¯æ­·å²è¨˜éŒ„è¼‰å…¥
- è‡ªå‹•æ»¾å‹•åˆ°æœ€æ–°è¨Šæ¯

### 3. ä¿®æ­£çš„å•é¡Œ
- **trainingQuestion.ftl**: ä¿®æ­£äº†therapistId/therapistNameè®Šæ•¸æœªå®šç¾©çš„å•é¡Œ
- è£œå……äº†èŠå¤©APIä¸­ç¼ºå°‘çš„æ–¹æ³•
- æ·»åŠ äº†Frameworkä¾è³´åˆ°pom.xml
- çµ±ä¸€äº†DAOæ–¹æ³•å‘½å

## APIä½¿ç”¨ç¯„ä¾‹

### å»ºç«‹èŠå¤©å®¤
```javascript
$.ajax({
    url: caseMgntUrl + '/Chat/api/createChatRoom',
    type: 'POST',
    headers: {
        'Content-Type': 'application/json',
        'Authorization': 'Bearer ' + token
    },
    data: JSON.stringify({
        roomName: "æˆ‘çš„èŠå¤©å®¤",
        roomType: "GROUP",
        description: "èŠå¤©å®¤æè¿°"
    })
});
```

### ç™¼é€è¨Šæ¯
```javascript
$.ajax({
    url: caseMgntUrl + '/Chat/api/sendMessage',
    type: 'POST',
    headers: {
        'Content-Type': 'application/json',
        'Authorization': 'Bearer ' + token
    },
    data: JSON.stringify({
        roomId: 1,
        content: "Hello World!",
        messageType: "TEXT"
    })
});
```

### è¼‰å…¥è¨Šæ¯ï¼ˆæ”¯æ´åˆ†é ï¼‰
```javascript
// è¼‰å…¥æœ€æ–°è¨Šæ¯
$.ajax({
    url: caseMgntUrl + '/Chat/api/loadMessages',
    type: 'POST',
    headers: {
        'Content-Type': 'application/json',
        'Authorization': 'Bearer ' + token
    },
    data: JSON.stringify({
        roomId: 1,
        limit: 50
    })
});

// è¼‰å…¥æ­·å²è¨Šæ¯ï¼ˆåˆ†é ï¼‰
$.ajax({
    url: caseMgntUrl + '/Chat/api/loadMessages',
    type: 'POST',
    headers: {
        'Content-Type': 'application/json',
        'Authorization': 'Bearer ' + token
    },
    data: JSON.stringify({
        roomId: 1,
        limit: 20,
        beforeMessageId: 123  // è¼‰å…¥IDç‚º123ä¹‹å‰çš„è¨Šæ¯
    })
});
```
    type: 'POST',
    headers: {
        'Content-Type': 'application/json',
        'Authorization': 'Bearer ' + token
    },
    data: JSON.stringify({
        roomId: 1,
        limit: 50
    })
});
```

## ç›®å‰ç‹€æ…‹

### å·²å¯¦ç¾
- âœ… å®Œæ•´çš„èŠå¤©ç³»çµ±å¾Œç«¯æ¶æ§‹
- âœ… RESTful APIç«¯é»
- âœ… å‰ç«¯èŠå¤©ä»‹é¢
- âœ… ç¾¤çµ„èŠå¤©åŠŸèƒ½
- âœ… ç§äººèŠå¤©åŠŸèƒ½
- âœ… è¨Šæ¯å·²è®€ç‹€æ…‹
- âœ… æˆå“¡ç®¡ç†
- âœ… éŸ¿æ‡‰å¼è¨­è¨ˆ

### å¾…å„ªåŒ–ï¼ˆå¯é¸ï¼‰
- ğŸ”„ WebSocketæ”¯æ´ï¼ˆå³æ™‚æ¨é€ï¼‰
- ğŸ”„ æª”æ¡ˆä¸Šå‚³åŠŸèƒ½
- ğŸ”„ è¡¨æƒ…ç¬¦è™Ÿæ”¯æ´
- ğŸ”„ è¨Šæ¯æœå°‹åŠŸèƒ½
- ğŸ”„ èŠå¤©å®¤æ¬Šé™ç®¡ç†
- ğŸ”„ è¨Šæ¯åŠ å¯†
- ğŸ”„ é›¢ç·šè¨Šæ¯é€šçŸ¥

## æª”æ¡ˆçµæ§‹

```
FreeMarkerApp/
â”œâ”€â”€ src/main/java/demo/freemarker/
â”‚   â”œâ”€â”€ model/chat/           # èŠå¤©è³‡æ–™æ¨¡å‹
â”‚   â”œâ”€â”€ dao/chat/             # èŠå¤©è³‡æ–™å­˜å–å±¤
â”‚   â”œâ”€â”€ api/chat/             # èŠå¤©æ¥­å‹™é‚è¼¯å±¤
â”‚   â””â”€â”€ handler/restfulapi/chat/  # RESTful API
â”œâ”€â”€ ftl/chat/                 # å‰ç«¯æ¨¡æ¿
â”‚   â”œâ”€â”€ chatlist.ftl          # èŠå¤©å®¤åˆ—è¡¨
â”‚   â””â”€â”€ chatroom.ftl          # èŠå¤©å®¤é é¢
â””â”€â”€ pom.xml                   # å·²æ·»åŠ Frameworkä¾è³´
```

## ç³»çµ±éœ€æ±‚
- Java 17+
- MySQLè³‡æ–™åº«
- Maven 3.6+
- å·²é…ç½®çš„Frameworkæ¨¡çµ„

## ä½¿ç”¨èªªæ˜

### å‰ç«¯é é¢å­˜å–
1. **èŠå¤©å®¤åˆ—è¡¨é é¢**: `${caseMgntUrl}/ftl/chat/chatlist.ftl`
2. **èŠå¤©å®¤é é¢**: `${caseMgntUrl}/ftl/chat/chatroom.ftl?roomId={èŠå¤©å®¤ID}`

### ä¸»è¦åŠŸèƒ½æ“ä½œ

#### 1. å»ºç«‹èŠå¤©å®¤
- åœ¨èŠå¤©å®¤åˆ—è¡¨é é¢é»æ“Šã€Œå»ºç«‹èŠå¤©å®¤ã€æŒ‰éˆ•
- è¼¸å…¥èŠå¤©å®¤åç¨±å’Œæè¿°
- ç³»çµ±æœƒè‡ªå‹•å°‡å»ºç«‹è€…åŠ å…¥èŠå¤©å®¤

#### 2. åŠ å…¥èŠå¤©å®¤
- é€éèŠå¤©å®¤IDåŠ å…¥ç¾æœ‰èŠå¤©å®¤
- æˆ–ç”±å…¶ä»–æˆå“¡é‚€è«‹åŠ å…¥

#### 3. ç™¼é€è¨Šæ¯
- åœ¨èŠå¤©å®¤é é¢åº•éƒ¨è¼¸å…¥æ¡†è¼¸å…¥è¨Šæ¯
- æŒ‰ Enter éµæˆ–é»æ“Šç™¼é€æŒ‰éˆ•ç™¼é€
- æ”¯æ´æ–‡å­—è¨Šæ¯ï¼Œæœ€å¤§é•·åº¦1000å­—å…ƒ

#### 4. ç€è¦½æ­·å²è¨Šæ¯
- å‘ä¸Šæ»¾å‹•èŠå¤©è¨˜éŒ„æœƒè‡ªå‹•è¼‰å…¥æ›´å¤šæ­·å²è¨Šæ¯
- æ¯æ¬¡è¼‰å…¥20æ¢æ­·å²è¨Šæ¯
- è¼‰å…¥æ™‚æœƒä¿æŒç•¶å‰ç€è¦½ä½ç½®

#### 5. æ‰‹å‹•åˆ·æ–°
- é»æ“ŠèŠå¤©å®¤æ¨™é¡Œæ—çš„ã€Œåˆ·æ–°ã€æŒ‰éˆ•å¯æ‰‹å‹•è¼‰å…¥æœ€æ–°è¨Šæ¯
- å»ºè­°åœ¨ç¶²è·¯ä¸ç©©å®šæ™‚ä½¿ç”¨

### æ³¨æ„äº‹é …
1. éœ€è¦ç™»å…¥ç³»çµ±æ‰èƒ½ä½¿ç”¨èŠå¤©åŠŸèƒ½
2. åªæœ‰èŠå¤©å®¤æˆå“¡æ‰èƒ½æŸ¥çœ‹å’Œç™¼é€è¨Šæ¯
3. è¨Šæ¯ä¸€æ—¦ç™¼é€ç„¡æ³•æ’¤å›ï¼ˆåŠŸèƒ½å¯æ“´å±•ï¼‰
4. é›¢é–‹èŠå¤©å®¤å¾Œå°‡ç„¡æ³•æ¥æ”¶è©²èŠå¤©å®¤çš„è¨Šæ¯

### æ•…éšœæ’é™¤
- å¦‚æœç„¡æ³•è¼‰å…¥èŠå¤©å®¤ï¼Œè«‹æª¢æŸ¥ç™»å…¥ç‹€æ…‹
- å¦‚æœè¨Šæ¯ç„¡æ³•ç™¼é€ï¼Œè«‹é‡æ–°æ•´ç†é é¢
- å¦‚æœæ­·å²è¨Šæ¯ç„¡æ³•è¼‰å…¥ï¼Œè«‹æª¢æŸ¥ç¶²è·¯é€£ç·š

---

*æœ€å¾Œæ›´æ–°: 2024-12-26*
